{% extends "base.html" %}

{% block title %}{{ course.title }} - Course Details{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Course Header -->
            <div class="card bg-primary text-white mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="card-title mb-0">{{ course.title }}</h1>
                            <p class="card-text mb-2">{{ course.course_code }} | {{ course.language }} | {{ course.duration_weeks }} weeks ({{ course.duration_hours }} hours)</p>
                            <div class="d-flex align-items-center gap-3">
                                <span class="badge bg-light text-dark">{{ course.level or 'All Levels' }}</span>
                                {% if course.delivery_mode == 'online' %}
                                <span class="badge bg-info text-white">Online Learning</span>
                                {% elif course.delivery_mode == 'offline' %}
                                <span class="badge bg-secondary text-white">In-Person</span>
                                {% else %}
                                <span class="badge bg-primary text-white">Hybrid</span>
                                {% endif %}
                                {% if course.cef_eligible %}
                                <span class="badge bg-warning text-dark">CEF Eligible</span>
                                {% endif %}
                                <span class="badge bg-success">{{ course.available_spots }} spots available</span>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <h2 class="mb-0">HK${{ "{:,.0f}".format(course.fee_hkd) }}</h2>
                            <small>Course Fee</small>
                            {% if course.cef_eligible and course.cef_fee_hkd %}
                            <div class="mt-2">
                                <small>CEF Price: HK${{ "{:,.0f}".format(course.cef_fee_hkd) }}</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Course Content -->
                <div class="col-md-8">
                    <!-- Course Description -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title mb-0">Course Description</h3>
                        </div>
                        <div class="card-body">
                            <div class="course-description">
                                {{ course.description | safe }}
                            </div>
                        </div>
                    </div>

                    <!-- Course Content -->
                    {% if course.course_content %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title mb-0">Course Content</h3>
                        </div>
                        <div class="card-body">
                            <div class="course-content">
                                {{ course.course_content | safe }}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Learning Outcomes -->
                    {% if course.learning_outcomes %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title mb-0">Learning Outcomes</h3>
                        </div>
                        <div class="card-body">
                            <div class="learning-outcomes">
                                {{ course.learning_outcomes | safe }}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Assessment Method -->
                    {% if course.assessment_method %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title mb-0">Assessment Method</h3>
                        </div>
                        <div class="card-body">
                            <div class="assessment-method">
                                {{ course.assessment_method | safe }}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Course Modules & Lessons -->
                    {% if modules %}
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h3 class="card-title mb-0">
                                <i class="fas fa-list-ol me-2"></i>Course Curriculum ({{ modules|length }} Modules)
                            </h3>
                        </div>
                        <div class="card-body p-0">
                            <div class="accordion" id="modulesAccordion">
                                {% for module in modules %}
                                <div class="accordion-item border-0 border-bottom">
                                    <h4 class="accordion-header" id="heading{{ module.id }}">
                                        <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#collapse{{ module.id }}" 
                                                aria-expanded="{% if loop.first %}true{% else %}false{% endif %}" 
                                                aria-controls="collapse{{ module.id }}">
                                            <div class="d-flex align-items-start w-100">
                                                <div class="me-3">
                                                    <span class="badge bg-primary rounded-circle" style="width: 35px; height: 35px; line-height: 35px;">
                                                        {{ loop.index }}
                                                    </span>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="fw-bold">{{ module.title }}</div>
                                                    {% if module.description %}
                                                    <div class="text-muted small mt-1">{{ module.description[:100] }}{% if module.description|length > 100 %}...{% endif %}</div>
                                                    {% endif %}
                                                    <div class="text-muted small mt-1">
                                                        <i class="fas fa-book me-1"></i>{{ module.lessons|length }} lessons
                                                        {% if module.estimated_duration_hours %}
                                                        Â· <i class="fas fa-clock me-1"></i>{{ module.estimated_duration_hours }}h
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </button>
                                    </h4>
                                    <div id="collapse{{ module.id }}" 
                                         class="accordion-collapse collapse {% if loop.first %}show{% endif %}" 
                                         aria-labelledby="heading{{ module.id }}" 
                                         data-bs-parent="#modulesAccordion">
                                        <div class="accordion-body bg-light">
                                            {% if module.description %}
                                            <p class="mb-3">{{ module.description }}</p>
                                            {% endif %}
                                            
                                            {% if module.lessons %}
                                            <h6 class="fw-bold mb-3">Lessons in this module:</h6>
                                            <ul class="list-unstyled">
                                                {% for lesson in module.lessons|sort(attribute='order') %}
                                                <li class="mb-2 d-flex align-items-start">
                                                    <span class="me-2 text-muted">{{ loop.index }}.</span>
                                                    <div class="flex-grow-1">
                                                        <div class="fw-semibold">
                                                            {{ lesson.title }}
                                                            {% if not is_enrolled %}
                                                            <i class="fas fa-lock text-muted ms-2" title="Enroll to access"></i>
                                                            {% endif %}
                                                        </div>
                                                        {% if lesson.description %}
                                                        <div class="text-muted small">{{ lesson.description }}</div>
                                                        {% endif %}
                                                        {% if lesson.duration_minutes %}
                                                        <div class="text-muted small">
                                                            <i class="fas fa-clock me-1"></i>{{ lesson.duration_minutes }} min
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </li>
                                                {% endfor %}
                                            </ul>
                                            {% else %}
                                            <p class="text-muted mb-0">
                                                <i class="fas fa-info-circle me-2"></i>Lesson content will be available after enrollment.
                                            </p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Course Information Sidebar -->
                <div class="col-md-4">
                    <!-- Apply Button -->
                    <div class="card mb-4">
                        <div class="card-body text-center">
                            {% if current_user.is_authenticated %}
                                {% if has_applied %}
                                    <div class="alert alert-info mb-3">
                                        <i class="fas fa-check-circle me-2"></i>
                                        You have already applied for this course
                                    </div>
                                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">
                                        View Application Status
                                    </a>
                                {% elif course.is_full %}
                                    <div class="alert alert-warning mb-3">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        This course is currently full
                                    </div>
                                    <button class="btn btn-secondary" disabled>Course Full</button>
                                {% else %}
                                    <a href="{{ url_for('apply_course', course_id=course.id) }}" class="btn btn-primary btn-lg">
                                        <i class="fas fa-file-alt me-2"></i>Apply Now
                                    </a>
                                {% endif %}
                            {% else %}
                                <div class="alert alert-info mb-3">
                                    Please log in to apply for this course
                                </div>
                                <a href="{{ url_for('login') }}" class="btn btn-primary">Login to Apply</a>
                                <a href="{{ url_for('register') }}" class="btn btn-outline-primary">Register</a>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Course Details -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Course Details</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Course Code:</strong></td>
                                    <td>{{ course.code }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Duration:</strong></td>
                                    <td>{{ course.duration_weeks }} weeks ({{ course.duration_hours }} hours)</td>
                                </tr>
                                <tr>
                                    <td><strong>Language:</strong></td>
                                    <td>{{ course.language }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Level:</strong></td>
                                    <td>{{ course.level or 'All Levels' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Class Size:</strong></td>
                                    <td>{{ course.min_students }}-{{ course.max_students }} students</td>
                                </tr>
                                <tr>
                                    <td><strong>Available Spots:</strong></td>
                                    <td><strong>{{ course.available_spots }}</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>Fee:</strong></td>
                                    <td><strong>HK${{ "{:,.0f}".format(course.fee_hkd) }}</strong></td>
                                </tr>
                                {% if course.cef_eligible %}
                                <tr>
                                    <td><strong>CEF Price:</strong></td>
                                    <td><strong>HK${{ "{:,.0f}".format(course.cef_fee_hkd or course.fee_hkd) }}</strong></td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>

                    <!-- Prerequisites -->
                    {% if course.prerequisites %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Prerequisites</h5>
                        </div>
                        <div class="card-body">
                            <div class="prerequisites-text">
                                {{ course.prerequisites | safe }}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Certification -->
                    {% if course.certification %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Certification</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">{{ course.certification }}</p>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Next Steps -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Application Process</h5>
                        </div>
                        <div class="card-body">
                            <ol class="small">
                                <li>Submit online application</li>
                                <li>Application review (3-5 business days)</li>
                                <li>Interview (if required)</li>
                                <li>Receive admission decision</li>
                                <li>Complete payment</li>
                                <li>Course materials sent</li>
                                <li>Classes begin</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.course-description ul, .course-content ul, .learning-outcomes ul, .assessment-method ul, .prerequisites-text ul {
    padding-left: 1rem;
}
.course-description li, .course-content li, .learning-outcomes li, .assessment-method li, .prerequisites-text li {
    margin-bottom: 0.5rem;
}
</style>
{% endblock %}
