{% extends "base.html" %}

{% block title %}Payment - {{ course.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-credit-card me-2"></i>Payment for {{ course.name }}
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Payment Summary -->
                    <div class="alert alert-info">
                        <h5><i class="fas fa-info-circle me-2"></i>Payment Summary</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Course:</strong> {{ course.name }}<br>
                                <strong>Code:</strong> {{ course.code }}<br>
                                <strong>Student:</strong> {{ current_user.full_name }}
                            </div>
                            <div class="col-md-6">
                                <strong>Amount:</strong> HK${{ "{:,.0f}".format(amount) }}<br>
                                <strong>Method:</strong> {{ payment_method.title() }}<br>
                                <strong>Reference:</strong> {{ payment_reference }}
                            </div>
                        </div>
                    </div>

                    <!-- Payment Instructions -->
                    <div class="payment-instructions">
                        <h5>{{ instructions.title }}</h5>
                        <p class="text-muted">{{ instructions.description }}</p>
                        
                        <div class="card bg-light">
                            <div class="card-body">
                                <ol>
                                    {% for step in instructions.steps %}
                                    <li>{{ step }}</li>
                                    {% endfor %}
                                </ol>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Method Specific Content -->
                    {% if payment_method == 'credit_card' %}
                    <div class="mt-4">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Demo Mode:</strong> This is a demonstration system. No actual payment will be processed.
                        </div>
                        
                        <form class="payment-form">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label class="form-label">Card Number</label>
                                        <input type="text" class="form-control" placeholder="1234 5678 9012 3456" value="4111 1111 1111 1111" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">CVV</label>
                                        <input type="text" class="form-control" placeholder="123" value="123" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Expiry Date</label>
                                        <input type="text" class="form-control" placeholder="MM/YY" value="12/26" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Cardholder Name</label>
                                        <input type="text" class="form-control" value="{{ current_user.full_name }}" readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid">
                                <button type="button" class="btn btn-success btn-lg" onclick="processPayment()">
                                    <i class="fas fa-lock me-2"></i>Complete Payment - HK${{ "{:,.0f}".format(amount) }}
                                </button>
                            </div>
                        </form>
                    </div>

                    {% elif payment_method == 'bank_transfer' %}
                    <div class="mt-4">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            Please complete the bank transfer and email the proof to finance@penasia.edu.hk
                        </div>
                        
                        <div class="d-grid">
                            <a href="{{ url_for('student_dashboard') }}" class="btn btn-primary">
                                Return to Dashboard
                            </a>
                        </div>
                    </div>

                    {% elif payment_method == 'installments' %}
                    <div class="mt-4">
                        <div class="alert alert-info">
                            <i class="fas fa-calendar me-2"></i>
                            Your installment schedule has been set up. First payment is due immediately.
                        </div>
                        
                        <div class="d-grid">
                            <button type="button" class="btn btn-primary btn-lg" onclick="processInstallmentPayment()">
                                <i class="fas fa-credit-card me-2"></i>Pay First Installment - HK${{ "{:,.0f}".format(amount/3) }}
                            </button>
                        </div>
                    </div>

                    {% elif payment_method == 'cef' %}
                    <div class="mt-4">
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle me-2"></i>
                            Please pay the full amount now. CEF reimbursement can be claimed after course completion.
                        </div>
                        
                        <div class="d-grid">
                            <button type="button" class="btn btn-warning btn-lg" onclick="processCEFPayment()">
                                <i class="fas fa-credit-card me-2"></i>Pay Full Amount - HK${{ "{:,.0f}".format(amount) }}
                            </button>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Return to Dashboard -->
                    <div class="mt-4 text-center">
                        <a href="{{ url_for('student_dashboard') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Return to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Success Modal -->
<div class="modal fade" id="paymentSuccessModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Payment Successful
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                <h4 class="mt-3">Payment Completed!</h4>
                <p>Thank you for your payment. You will receive a confirmation email shortly.</p>
                <div class="alert alert-info">
                    <strong>Reference:</strong> {{ payment_reference }}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="window.location.href='{{ url_for('student_dashboard') }}'">
                    Go to Dashboard
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function processPayment() {
    // Simulate payment processing
    setTimeout(function() {
        // In a real system, this would make an AJAX call to process payment
        $('#paymentSuccessModal').modal('show');
        
        // Simulate backend call to update payment status
        fetch('/api/process-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                reference: '{{ payment_reference }}',
                amount: {{ amount }},
                method: '{{ payment_method }}'
            })
        });
    }, 2000);
}

function processInstallmentPayment() {
    // Similar to regular payment but for installments
    processPayment();
}

function processCEFPayment() {
    // Similar to regular payment but with CEF handling
    processPayment();
}
</script>

<style>
.payment-form {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 0.5rem;
    border: 1px solid #dee2e6;
}

.payment-instructions {
    margin: 1.5rem 0;
}

.payment-instructions ol {
    margin-bottom: 0;
}

.payment-instructions ol li {
    margin-bottom: 0.5rem;
}
</style>
{% endblock %}
