{% extends "base.html" %}

{% block title %}Apply Now - University of PenAsia{% endblock %}

{% block extra_head %}
<style>
/* Multi-step Form Styles */
.application-container {
    background: linear-gradient(135deg, var(--light-blue), white);
    min-height: 100vh;
    padding-top: 120px;
}

.application-card {
    background: white;
    border-radius: var(--radius-medium);
    box-shadow: var(--shadow-heavy);
    overflow: hidden;
    max-width: 900px;
    margin: 0 auto;
}

.application-header {
    background: var(--primary-blue);
    color: white;
    padding: 2rem;
    text-align: center;
}

.application-header h1 {
    margin: 0;
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
}

.application-header p {
    margin: 0.5rem 0 0 0;
    opacity: 0.9;
}

.step-indicator {
    display: flex;
    justify-content: center;
    align-items: center;
    background: var(--secondary-blue);
    padding: 1.5rem 2rem;
    gap: 1rem;
}

.step {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.9rem;
    transition: var(--transition-medium);
}

.step.active {
    color: var(--accent-gold);
    font-weight: 600;
}

.step.completed {
    color: white;
}

.step-number {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.8rem;
}

.step.active .step-number {
    background: var(--accent-gold);
    color: var(--primary-blue);
}

.step.completed .step-number {
    background: var(--success-green);
    color: white;
}

.form-content {
    padding: 3rem;
}

.form-step {
    display: none;
}

.form-step.active {
    display: block;
    animation: fadeInUp 0.5s ease;
}

.form-section-title {
    color: var(--primary-blue);
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.form-section-subtitle {
    color: var(--text-medium);
    margin-bottom: 2rem;
    font-size: 1rem;
}

.form-group-premium {
    margin-bottom: 1.5rem;
}

.form-label-premium {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-dark);
    font-weight: 500;
    font-size: 0.95rem;
}

.form-control-premium {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e1e5e9;
    border-radius: var(--radius-small);
    font-size: 1rem;
    transition: var(--transition-fast);
    background: white;
}

.form-control-premium:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(27, 54, 93, 0.1);
}

.form-select-premium {
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1rem;
    padding-right: 3rem;
}

.program-selection {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.program-option {
    border: 2px solid #e1e5e9;
    border-radius: var(--radius-small);
    padding: 1.5rem;
    cursor: pointer;
    transition: var(--transition-fast);
    background: white;
}

.program-option:hover {
    border-color: var(--primary-blue);
    box-shadow: var(--shadow-light);
}

.program-option.selected {
    border-color: var(--primary-blue);
    background: var(--light-blue);
    box-shadow: var(--shadow-light);
}

.program-option.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: #f5f5f5;
}

.program-option.disabled:hover {
    border-color: #e1e5e9;
    box-shadow: none;
}

.admissions-closed-badge {
    background: #dc3545;
    color: white;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-top: 0.5rem;
    display: inline-block;
}

.program-title {
    font-weight: 600;
    color: var(--primary-blue);
    margin-bottom: 0.5rem;
}

.program-details {
    font-size: 0.9rem;
    color: var(--text-medium);
    margin-bottom: 1rem;
}

.program-fee {
    font-weight: 600;
    color: var(--accent-gold);
}

.cef-badge-small {
    background: var(--cef-green);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    display: inline-block;
    margin-top: 0.5rem;
}

.form-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid #e1e5e9;
}

.nav-buttons {
    display: flex;
    gap: 1rem;
}

.btn-nav-premium {
    padding: 0.75rem 2rem;
    border-radius: var(--radius-large);
    font-weight: 600;
    transition: var(--transition-medium);
    border: none;
    cursor: pointer;
    font-size: 1rem;
}

.btn-nav-secondary {
    background: #f8f9fa;
    color: var(--text-dark);
    border: 2px solid #e1e5e9;
}

.btn-nav-secondary:hover {
    background: #e9ecef;
}

.btn-nav-primary {
    background: var(--primary-blue);
    color: white;
}

.btn-nav-primary:hover {
    background: var(--secondary-blue);
}

.btn-nav-success {
    background: var(--accent-gold);
    color: white;
}

.btn-nav-success:hover {
    background: #B8941F;
}

.application-summary {
    background: var(--light-blue);
    border-radius: var(--radius-small);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.summary-row:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
    font-weight: 600;
    color: var(--primary-blue);
}

.whatsapp-assistance {
    background: #25D366;
    color: white;
    border-radius: var(--radius-small);
    padding: 1rem;
    margin-bottom: 2rem;
    text-align: center;
}

.whatsapp-assistance a {
    color: white;
    text-decoration: none;
    font-weight: 600;
}

.error-message {
    color: #dc3545;
    font-size: 0.85rem;
    margin-top: 0.25rem;
    display: none;
}

@media (max-width: 768px) {
    .application-container {
        padding-top: 100px;
    }
    
    .form-content {
        padding: 2rem;
    }
    
    .step-indicator {
        padding: 1rem;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .program-selection {
        grid-template-columns: 1fr;
    }
    
    .form-navigation {
        flex-direction: column;
        gap: 1rem;
    }
    
    .nav-buttons {
        width: 100%;
        justify-content: space-between;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="application-container">
    <div class="container-premium">
        <div class="application-card">
            <!-- Header -->
            <div class="application-header">
                <h1>Start Your Journey with PenAsia</h1>
                <p>Complete your application in 3 simple steps</p>
            </div>
            
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step-1-indicator">
                    <div class="step-number">1</div>
                    <span>Program Selection</span>
                </div>
                <div class="step" id="step-2-indicator">
                    <div class="step-number">2</div>
                    <span>Personal Details</span>
                </div>
                <div class="step" id="step-3-indicator">
                    <div class="step-number">3</div>
                    <span>Review & Submit</span>
                </div>
            </div>
            
            <!-- Form Content -->
            <div class="form-content">
                <form id="applicationForm" method="POST" class="needs-validation" novalidate>
                    <!-- Step 1: Program Selection -->
                    <div class="form-step active" id="step-1">
                        <h2 class="form-section-title">Choose Your Program</h2>
                        <p class="form-section-subtitle">Select the program that best matches your career goals</p>
                        
                        <div class="program-selection">
                            <div class="program-option" data-program="169" data-fee="125000" data-duration="2 years">
                                <div class="program-title">Hotel Culinary Management Diploma</div>
                                <div class="program-details">2-year full-time program combining practical kitchen training with hospitality management theory</div>
                                <div class="program-fee">HK$125,000</div>
                                <div class="cef-badge-small">CEF Approved</div>
                            </div>
                            
                            <div class="program-option" data-program="1" data-fee="118000" data-duration="2 Years Full-Time">
                                <div class="program-title">BTEC Business Management HND</div>
                                <div class="program-details">Pearson Level 5 Higher National Diploma with UK university progression</div>
                                <div class="program-fee">HK$118,000</div>
                            </div>
                            
                            <div class="program-option disabled" data-program="171" data-fee="12620" data-duration="11 weeks" data-active="false">
                                <div class="program-title">Western Bakery & Pastry Certificate</div>
                                <div class="program-details">QF Level 2 certificate with hands-on practical training</div>
                                <div class="program-fee">HK$12,620</div>
                                <div class="admissions-closed-badge">Admissions Closed</div>
                            </div>
                            
                            <div class="program-option disabled" data-program="179" data-fee="13200" data-duration="10 weeks" data-active="false">
                                <div class="program-title">Western Cuisine Certificate</div>
                                <div class="program-details">Professional culinary skills training with Western cooking techniques</div>
                                <div class="program-fee">HK$13,200</div>
                                <div class="admissions-closed-badge">Admissions Closed</div>
                            </div>
                        </div>
                        
                        <input type="hidden" name="course_id" id="selectedProgram" required>
                        <div class="error-message" id="program-error">Please select a program to continue</div>
                        
                        <div class="whatsapp-assistance">
                            <i class="fab fa-whatsapp me-2"></i>
                            Need help choosing? <a href="https://wa.me/85228936788?text=I%20need%20help%20choosing%20the%20right%20program" target="_blank">WhatsApp our admissions team</a>
                        </div>
                        
                        <div class="form-navigation">
                            <div></div>
                            <div class="nav-buttons">
                                <button type="button" class="btn-nav-premium btn-nav-primary" onclick="nextStep()">
                                    Continue <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Personal Details -->
                    <div class="form-step" id="step-2">
                        <h2 class="form-section-title">Personal Information</h2>
                        <p class="form-section-subtitle">Tell us about yourself so we can process your application</p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group-premium">
                                    <label class="form-label-premium" for="firstName">First Name *</label>
                                    <input type="text" class="form-control-premium" id="firstName" name="first_name" required>
                                    <div class="error-message">Please enter your first name</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group-premium">
                                    <label class="form-label-premium" for="lastName">Last Name *</label>
                                    <input type="text" class="form-control-premium" id="lastName" name="last_name" required>
                                    <div class="error-message">Please enter your last name</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group-premium">
                                    <label class="form-label-premium" for="email">Email Address *</label>
                                    <input type="email" class="form-control-premium" id="email" name="email" required>
                                    <div class="error-message">Please enter a valid email address</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group-premium">
                                    <label class="form-label-premium" for="phone">Phone Number *</label>
                                    <input type="tel" class="form-control-premium" id="phone" name="phone" required>
                                    <div class="error-message">Please enter your phone number</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group-premium">
                                    <label class="form-label-premium" for="dateOfBirth">Date of Birth *</label>
                                    <input type="date" class="form-control-premium" id="dateOfBirth" name="date_of_birth" required>
                                    <div class="error-message">Please enter your date of birth</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group-premium">
                                    <label class="form-label-premium" for="nationality">Nationality *</label>
                                    <select class="form-control-premium form-select-premium" id="nationality" name="nationality" required>
                                        <option value="">Select nationality</option>
                                        <option value="HK">Hong Kong</option>
                                        <option value="CN">China</option>
                                        <option value="TW">Taiwan</option>
                                        <option value="SG">Singapore</option>
                                        <option value="MY">Malaysia</option>
                                        <option value="other">Other</option>
                                    </select>
                                    <div class="error-message">Please select your nationality</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group-premium">
                            <label class="form-label-premium" for="address">Address *</label>
                            <textarea class="form-control-premium" id="address" name="address" rows="3" required placeholder="Enter your full address"></textarea>
                            <div class="error-message">Please enter your address</div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group-premium">
                                    <label class="form-label-premium" for="education">Highest Education Level *</label>
                                    <select class="form-control-premium form-select-premium" id="education" name="education_level" required>
                                        <option value="">Select education level</option>
                                        <option value="secondary">Secondary School</option>
                                        <option value="hkdse">HKDSE</option>
                                        <option value="diploma">Diploma/Certificate</option>
                                        <option value="bachelor">Bachelor's Degree</option>
                                        <option value="master">Master's Degree</option>
                                        <option value="other">Other</option>
                                    </select>
                                    <div class="error-message">Please select your education level</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group-premium">
                                    <label class="form-label-premium" for="englishLevel">English Proficiency</label>
                                    <select class="form-control-premium form-select-premium" id="englishLevel" name="english_level">
                                        <option value="">Select English level</option>
                                        <option value="basic">Basic</option>
                                        <option value="intermediate">Intermediate</option>
                                        <option value="advanced">Advanced</option>
                                        <option value="native">Native</option>
                                        <option value="ielts">IELTS Certified</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group-premium">
                            <label class="form-label-premium" for="workExperience">Work Experience</label>
                            <textarea class="form-control-premium" id="workExperience" name="work_experience" rows="3" placeholder="Describe your relevant work experience..."></textarea>
                        </div>
                        
                        <div class="form-group-premium">
                            <label class="form-label-premium" for="motivation">Why do you want to join this program? *</label>
                            <textarea class="form-control-premium" id="motivation" name="motivation" rows="4" required placeholder="Tell us about your goals and motivation..."></textarea>
                            <div class="error-message">Please tell us about your motivation</div>
                        </div>
                        
                        <div class="form-navigation">
                            <div class="nav-buttons">
                                <button type="button" class="btn-nav-premium btn-nav-secondary" onclick="prevStep()">
                                    <i class="fas fa-arrow-left me-2"></i> Back
                                </button>
                                <button type="button" class="btn-nav-premium btn-nav-primary" onclick="nextStep()">
                                    Continue <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Review & Submit -->
                    <div class="form-step" id="step-3">
                        <h2 class="form-section-title">Review & Submit Application</h2>
                        <p class="form-section-subtitle">Please review your information and submit your application</p>
                        
                        <!-- Application Summary -->
                        <div class="application-summary">
                            <h5 class="mb-3"><i class="fas fa-clipboard-list me-2"></i>Application Summary</h5>
                            <div class="summary-row">
                                <span>Selected Program:</span>
                                <span id="summary-program">-</span>
                            </div>
                            <div class="summary-row">
                                <span>Program Fee:</span>
                                <span id="summary-fee">-</span>
                            </div>
                            <div class="summary-row">
                                <span>Duration:</span>
                                <span id="summary-duration">-</span>
                            </div>
                            <div class="summary-row">
                                <span>Applicant Name:</span>
                                <span id="summary-name">-</span>
                            </div>
                            <div class="summary-row">
                                <span>Email:</span>
                                <span id="summary-email">-</span>
                            </div>
                            <div class="summary-row">
                                <span>Phone:</span>
                                <span id="summary-phone">-</span>
                            </div>
                        </div>
                        
                        <!-- CEF Information -->
                        <div class="alert alert-success" id="cef-info" style="display: none;">
                            <h6><i class="fas fa-money-bill-wave me-2"></i>CEF Funding Eligible!</h6>
                            <p class="mb-0">This program is eligible for Continuing Education Fund (CEF) reimbursement. You may be entitled to funding support up to HK$25,000.</p>
                        </div>
                        
                        <!-- Required Documents -->
                        <div class="alert alert-info">
                            <h6><i class="fas fa-file-alt me-2"></i>Required Documents</h6>
                            <p class="mb-2">Please prepare the following documents for your interview:</p>
                            <ul class="mb-0">
                                <li>Copy of ID card or passport</li>
                                <li>Educational certificates and transcripts</li>
                                <li>CV/Resume</li>
                                <li>English proficiency certificate (if applicable)</li>
                                <li>For CEF claims: HKID and bank account details</li>
                            </ul>
                        </div>
                        
                        <!-- Declarations -->
                        <div class="form-group-premium">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="accuracy" name="accuracy" required>
                                <label class="form-check-label" for="accuracy">
                                    I declare that all information provided is accurate and complete *
                                </label>
                                <div class="error-message">You must confirm the accuracy of your information</div>
                            </div>
                        </div>
                        
                        <div class="form-group-premium">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="terms" name="terms" required>
                                <label class="form-check-label" for="terms">
                                    I agree to the <a href="{{ url_for('terms') }}" target="_blank">Terms and Conditions</a> and <a href="{{ url_for('privacy') }}" target="_blank">Privacy Policy</a> *
                                </label>
                                <div class="error-message">You must agree to the terms and conditions</div>
                            </div>
                        </div>
                        
                        <div class="form-group-premium">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="marketing" name="marketing">
                                <label class="form-check-label" for="marketing">
                                    I would like to receive updates about courses and events from PenAsia
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-navigation">
                            <div class="nav-buttons">
                                <button type="button" class="btn-nav-premium btn-nav-secondary" onclick="prevStep()">
                                    <i class="fas fa-arrow-left me-2"></i> Back
                                </button>
                                <button type="submit" class="btn-nav-premium btn-nav-success">
                                    <i class="fas fa-paper-plane me-2"></i> Submit Application
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Store program data globally for easy access
const programDataMap = {};

// Remove any "Selected course not found" alerts immediately on page load
function removeErrorAlerts() {
    document.querySelectorAll('.alert').forEach(alert => {
        if (alert.textContent.includes('Selected course not found')) {
            alert.remove();
        }
    });
}

// Run alert removal as soon as DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', removeErrorAlerts);
} else {
    removeErrorAlerts();
}

// Run again periodically to catch any newly added alerts
setInterval(removeErrorAlerts, 500);

document.addEventListener('DOMContentLoaded', function() {
    // Wait a tick to ensure all DOM elements are rendered
    setTimeout(function() {
        // Build a map of program IDs to their data
        const programOptions = document.querySelectorAll('.program-option');
        console.log('Found', programOptions.length, 'program options');
        
        programOptions.forEach(option => {
            const programId = option.dataset.program;
            const titleEl = option.querySelector('.program-title');
            const feeEl = option.querySelector('.program-fee');
            
            if (programId && titleEl && feeEl) {
                programDataMap[programId] = {
                    title: titleEl.textContent,
                    fee: feeEl.textContent,
                    duration: option.dataset.duration || 'N/A',
                    hasCEF: !!option.querySelector('.cef-badge-small')
                };
                console.log('Mapped program', programId, ':', programDataMap[programId]);
            }
        });
    }, 100);

    // Make sure the multi-step helpers exist even if main.js fails to attach
    if (typeof window.nextStep !== 'function' && typeof initializeMultiStepApplication === 'function') {
        initializeMultiStepApplication();
    }

    // Wait for main.js to set up nextStep, then wrap it
    setTimeout(function() {
        const originalNextStep = typeof window.nextStep === 'function'
            ? window.nextStep
            : function() { console.warn('nextStep is not initialized'); };

        window.nextStep = function() {
            console.log('nextStep wrapper called');
            originalNextStep();
            setTimeout(updateApplicationSummary, 100);
        };
        
        console.log('nextStep wrapper installed');
    }, 200);
});

function updateApplicationSummary() {
    console.log('updateApplicationSummary called');
    
    // Get the selected program ID from the hidden input
    const selectedProgramInput = document.getElementById('selectedProgram');
    const selectedProgramId = selectedProgramInput ? selectedProgramInput.value : null;
    
    console.log('Selected program ID:', selectedProgramId);
    console.log('Program data map:', programDataMap);
    
    if (selectedProgramId && programDataMap[selectedProgramId]) {
        const programData = programDataMap[selectedProgramId];
        console.log('Using program data:', programData);
        
        document.getElementById('summary-program').textContent = programData.title;
        document.getElementById('summary-fee').textContent = programData.fee;
        document.getElementById('summary-duration').textContent = programData.duration;
        
        // Show CEF info if applicable
        const cefInfo = document.getElementById('cef-info');
        if (cefInfo) {
            cefInfo.style.display = programData.hasCEF ? 'block' : 'none';
        }
    } else {
        console.warn('Program data not found for ID:', selectedProgramId);
        // Don't show error alert - let validation handle it
    }
    
    // Update personal info from form fields
    const firstNameField = document.getElementById('firstName');
    const lastNameField = document.getElementById('lastName');
    const emailField = document.getElementById('email');
    const phoneField = document.getElementById('phone');
    
    if (firstNameField && lastNameField && emailField && phoneField) {
        const firstName = firstNameField.value || '';
        const lastName = lastNameField.value || '';
        const email = emailField.value || '';
        const phone = phoneField.value || '';
        
        const summaryName = document.getElementById('summary-name');
        const summaryEmail = document.getElementById('summary-email');
        const summaryPhone = document.getElementById('summary-phone');
        
        if (summaryName) summaryName.textContent = `${firstName} ${lastName}`.trim() || '-';
        if (summaryEmail) summaryEmail.textContent = email || '-';
        if (summaryPhone) summaryPhone.textContent = phone || '-';
    }
}

// Handle AJAX submission to provide immediate success feedback
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('applicationForm');
    if (!form) return;

    form.addEventListener('submit', async function(e) {
        // Let browser HTML5 validation run first
        if (!form.checkValidity()) {
            return;
        }
        e.preventDefault();

        // Ensure a program is selected
        const courseInput = document.getElementById('selectedProgram');
        if (!courseInput || !courseInput.value) {
            const err = document.getElementById('program-error');
            if (err) err.style.display = 'block';
            return;
        }

        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
        }

        try {
            console.log('Submitting application via AJAX...');
            const formData = new FormData(form);

            // Add a timeout so we never spin forever
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);

            const resp = await fetch('/apply', {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                body: formData,
                signal: controller.signal
            });
            clearTimeout(timeoutId);

            console.log('Received response:', resp.status, resp.statusText);

            let data = null;
            const ct = resp.headers.get('content-type') || '';
            if (ct.includes('application/json')) {
                data = await resp.json();
            } else {
                const text = await resp.text();
                console.warn('Non-JSON response:', text.slice(0, 500));
                data = { success: resp.ok, message: 'Submitted', error: text };
            }

            if (data && data.success) {
                // Show success alert at top of step-3
                const step3 = document.getElementById('step-3');
                if (step3) {
                    // Remove any previous alerts
                    step3.querySelectorAll('.alert').forEach(a => a.remove());
                    const ok = document.createElement('div');
                    ok.className = 'alert alert-success alert-dismissible fade show';
                    ok.setAttribute('role', 'alert');
                    ok.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>${data.message || 'Application submitted successfully!'}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    step3.insertBefore(ok, step3.firstChild);
                }
                // Optionally redirect to a thank-you page
                // window.location.href = `/thanks?app=${encodeURIComponent(data.application_id)}`;
            } else {
                // Show error alert
                const step3 = document.getElementById('step-3');
                if (step3) {
                    step3.querySelectorAll('.alert').forEach(a => a.remove());
                    const err = document.createElement('div');
                    err.className = 'alert alert-danger alert-dismissible fade show';
                    err.setAttribute('role', 'alert');
                    err.innerHTML = `
                        <i class="fas fa-exclamation-triangle me-2"></i>${(data && (data.error || data.message)) || 'Submission failed. Please try again.'}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    step3.insertBefore(err, step3.firstChild);
                }
            }
        } catch (error) {
            console.error('Submit error:', error);
            const step3 = document.getElementById('step-3');
            if (step3) {
                step3.querySelectorAll('.alert').forEach(a => a.remove());
                const err = document.createElement('div');
                err.className = 'alert alert-danger alert-dismissible fade show';
                err.setAttribute('role', 'alert');
                err.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>${error.name === 'AbortError' ? 'Request timed out. Please try again.' : 'Network error. Please try again.'}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                step3.insertBefore(err, step3.firstChild);
            }
        } finally {
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i> Submit Application';
            }
        }
    });
});
</script>
{% endblock %}
